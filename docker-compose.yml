version: '3.8'

services:
  # Nginx reverse proxy serving Elm frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ui-automation-frontend${WORKSPACE_SUFFIX:-}
    ports:
      - "${APP_PORT:-8080}:80"
    volumes:
      # Mount locally-built Elm application for live development
      # Rebuild with: cd frontend && elm make src/App.elm --output=elm.js
      - ./frontend/elm.js:/usr/share/nginx/html/elm.js:ro
      - ./frontend/index.html:/usr/share/nginx/html/index.html:ro
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - ui-automation-network

  # Playwright MCP sidecar for browser automation
  playwright-mcp:
    build:
      context: ./playwright-mcp
      dockerfile: Dockerfile
    container_name: ui-automation-playwright-mcp${WORKSPACE_SUFFIX:-}
    networks:
      - ui-automation-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/sse', r => { r.statusCode === 200 ? process.exit(0) : process.exit(1) }).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Go backend API
  backend:
    build:
      context: .
      dockerfile: cmd/backend/Dockerfile
    container_name: ui-automation-backend${WORKSPACE_SUFFIX:-}
    environment:
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - DATABASE_HOST=mysql
      - DATABASE_PORT=3306
      - DATABASE_USER=root
      - DATABASE_PASSWORD=password
      - DATABASE_DATABASE=ui_automation
      - SESSION_COOKIE_NAME=session_id
      - SESSION_COOKIE_SECRET=change-this-secret-in-production-min-32-chars
      - SESSION_DURATION=24h
      - SESSION_SECURE=false
      - STORAGE_TYPE=local
      - STORAGE_BASE_DIR=/uploads
      - LOG_LEVEL=info
      - AGENT_PLAYWRIGHT_MCP_URL=http://playwright-mcp:3000
      - AGENT_MAX_ITERATIONS=50
      - AGENT_TIME_LIMIT=10m
      - AGENT_BEDROCK_REGION=${AWS_REGION:-us-east-1}
      - AGENT_BEDROCK_MODEL=anthropic.claude-sonnet-4-6
      - AGENT_BEDROCK_ACCESS_KEY=${AWS_ACCESS_KEY_ID:-}
      - AGENT_BEDROCK_SECRET_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AGENT_MAX_CONCURRENT_WORKERS=1
      - AGENT_SCRIPT_PATH=/root/agent/agent_runner.py
      - CLAUDE_CODE_USE_BEDROCK=1
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
    volumes:
      - uploads_data:/uploads
    depends_on:
      mysql:
        condition: service_healthy
      playwright-mcp:
        condition: service_healthy
    networks:
      - ui-automation-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Database migration (runs once on startup)
  migrate:
    build:
      context: .
      dockerfile: cmd/backend/Dockerfile
    container_name: ui-automation-migrate${WORKSPACE_SUFFIX:-}
    environment:
      - DATABASE_HOST=mysql
      - DATABASE_PORT=3306
      - DATABASE_USER=root
      - DATABASE_PASSWORD=password
      - DATABASE_DATABASE=ui_automation
    command: ["./backend", "migrate", "up", "-p", "database/migrations"]
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ui-automation-network
    restart: on-failure

  # MySQL database
  mysql:
    image: mysql:8
    container_name: ui-automation-db${WORKSPACE_SUFFIX:-}
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: ui_automation
    networks:
      - ui-automation-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-ppassword"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  ui-automation-network:
    driver: bridge
    name: ui-automation-network${WORKSPACE_SUFFIX:-}

volumes:
  uploads_data:
    name: uploads_data${WORKSPACE_SUFFIX:-}
